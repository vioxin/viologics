<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #1a5e20; color: white; text-align: center; padding: 20px; margin: 0; }
    .container { max-width: 600px; margin: 0 auto; background: #2e7d32; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; box-sizing: border-box; }
    .card-area { min-height: 110px; margin: 10px auto; padding: 10px; border: 2px dashed #4caf50; border-radius: 10px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
    
    /* ã‚«ãƒ¼ãƒ‰é…ã‚Šã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes slideDown {
      0% { opacity: 0; transform: translateY(-50px) scale(1.1); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .card { background: white; width: 60px; height: 90px; border-radius: 8px; font-weight: bold; font-size: 1.5em; display: flex; align-items: center; justify-content: center; flex-direction: column; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); animation: slideDown 0.3s ease-out; }
    .card.hidden { background: #b71c1c; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px); border: 2px solid white; color: transparent; }
    .red { color: #e74c3c; }
    .black { color: #2c3e50; }
    
    .bet-area { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 15px; }
    input[type="number"] { padding: 10px; font-size: 1.2em; width: 100px; text-align: right; border-radius: 5px; border: none; }
    
    .controls { margin-top: 20px; }
    button { padding: 12px 25px; margin: 5px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; transition: 0.2s; }
    .btn-start { background: #f1c40f; color: #333; }
    .btn-action { background: #3498db; color: white; }
    button:disabled { background: #7f8c8d !important; color: #bdc3c7 !important; cursor: not-allowed; }
    #msg-box { font-size: 1.1em; font-weight: bold; margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; min-height: 1.5em; }
    .score-badge { background: #ffca28; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸƒ ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯</h2>
    <p>æ‰€æŒé‡‘: <span id="display-points" style="color: #f1c40f; font-weight: bold; font-size: 1.2em;">---</span> ã‚‚ã£ã¡</p>

    <div class="bet-area" id="bet-area">
      è³­ã‘é‡‘: <input type="number" id="bet-amount" value="300" min="100" step="100"> ã‚‚ã£ã¡
    </div>

    <div style="margin-top: 10px; text-align: left;">ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®æ‰‹æœ­ <span id="dealer-score-badge" class="score-badge" style="display:none;"></span></div>
    <div id="dealer-cards" class="card-area"></div>

    <div id="msg-box">ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

    <div style="text-align: left;">ã‚ãªãŸã®æ‰‹æœ­ <span id="player-score-badge" class="score-badge" style="display:none;"></span></div>
    <div id="player-cards" class="card-area"></div>

    <div class="controls">
      <button id="btn-start" class="btn-start" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      <button id="btn-hit" class="btn-action" onclick="hit()" style="display:none;">ãƒ’ãƒƒãƒˆ</button>
      <button id="btn-stand" class="btn-action" onclick="stand()" style="display:none;">ã‚¹ã‚¿ãƒ³ãƒ‰</button>
    </div>
    <br><a href="../index.html" style="color: #a5d6a7; text-decoration: none;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    let deck = [], playerHand = [], dealerHand = [];
    let betAmount = 0;
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;

    function createDeck() {
      const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
      const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      deck = [];
      suits.forEach(s => values.forEach(v => deck.push({ suit: s, value: v, isRed: (s === 'â™¥' || s === 'â™¦') })));
      deck.sort(() => Math.random() - 0.5); 
    }

    function calculateScore(hand) {
      let score = 0, aces = 0;
      for(let card of hand) {
        if(card.value === 'A') { score += 11; aces += 1; }
        else if(['J','Q','K'].includes(card.value)) { score += 10; }
        else { score += parseInt(card.value); }
      }
      while(score > 21 && aces > 0) { score -= 10; aces -= 1; }
      return score;
    }

    function renderCards(hideDealerCard) {
      const pArea = document.getElementById('player-cards');
      // é…åˆ—ã®æœ€å¾Œï¼ˆæœ€æ–°ï¼‰ã®ã‚«ãƒ¼ãƒ‰ã ã‘ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œã•ã›ã‚‹å·¥å¤«
      pArea.innerHTML = playerHand.map(c => 
        `<div class="card ${c.isRed ? 'red' : 'black'}"><div>${c.suit}</div><div>${c.value}</div></div>`
      ).join('');
      document.getElementById('player-score-badge').style.display = 'inline-block';
      document.getElementById('player-score-badge').innerText = calculateScore(playerHand) + "ç‚¹";

      const dArea = document.getElementById('dealer-cards');
      if (hideDealerCard) {
        dArea.innerHTML = 
          `<div class="card ${dealerHand[0].isRed ? 'red' : 'black'}"><div>${dealerHand[0].suit}</div><div>${dealerHand[0].value}</div></div>` +
          `<div class="card hidden"></div>`;
        document.getElementById('dealer-score-badge').style.display = 'none';
      } else {
        dArea.innerHTML = dealerHand.map(c => 
          `<div class="card ${c.isRed ? 'red' : 'black'}"><div>${c.suit}</div><div>${c.value}</div></div>`
        ).join('');
        document.getElementById('dealer-score-badge').style.display = 'inline-block';
        document.getElementById('dealer-score-badge').innerText = calculateScore(dealerHand) + "ç‚¹";
      }
    }

    function showMsg(msg) { document.getElementById('msg-box').innerText = msg; }

    async function startGame() {
      betAmount = parseInt(document.getElementById('bet-amount').value);
      if(betAmount < 100 || currentPoints < betAmount) { alert("è³­ã‘é‡‘ãŒä¸æ­£ã‹ã€ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“"); return; }
      
      currentPoints -= betAmount;
      updateDisplay();

      document.getElementById('bet-area').style.display = 'none';
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-hit').style.display = 'inline-block';
      document.getElementById('btn-stand').style.display = 'inline-block';
      document.getElementById('btn-hit').disabled = false;
      document.getElementById('btn-stand').disabled = false;

      createDeck();
      playerHand = [deck.pop(), deck.pop()];
      dealerHand = [deck.pop(), deck.pop()];

      renderCards(true);
      
      const pScore = calculateScore(playerHand);
      if(pScore === 21) {
        showMsg("âœ¨ ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ï¼");
        document.getElementById('btn-hit').disabled = true;
        document.getElementById('btn-stand').disabled = true;
        setTimeout(dealerTurn, 1000);
      } else {
        showMsg("ã€Œãƒ’ãƒƒãƒˆã€ã‹ã€Œã‚¹ã‚¿ãƒ³ãƒ‰ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
      }
    }

    function hit() {
      playerHand.push(deck.pop());
      renderCards(true);
      if(calculateScore(playerHand) > 21) {
        document.getElementById('btn-hit').disabled = true;
        document.getElementById('btn-stand').disabled = true;
        showMsg("ğŸ’¥ ãƒãƒ¼ã‚¹ãƒˆï¼");
        setTimeout(() => endGame(false, false, "ãƒãƒ¼ã‚¹ãƒˆã«ã‚ˆã‚‹æ•—åŒ—"), 1000);
      }
    }

    function stand() {
      document.getElementById('btn-hit').disabled = true;
      document.getElementById('btn-stand').disabled = true;
      showMsg("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã§ã™...");
      setTimeout(dealerTurn, 1000);
    }

    async function dealerTurn() {
      renderCards(false);
      await new Promise(r => setTimeout(r, 1000));

      while(calculateScore(dealerHand) < 17) {
        dealerHand.push(deck.pop());
        renderCards(false);
        await new Promise(r => setTimeout(r, 1000));
      }
      judgeResult();
    }

    function judgeResult() {
      const pScore = calculateScore(playerHand);
      const dScore = calculateScore(dealerHand);
      if(dScore > 21 || pScore > dScore) {
        endGame(true, false, `ã‚ãªãŸã®å‹ã¡ï¼`);
      } else if(pScore === dScore) {
        endGame(false, true, `å¼•ãåˆ†ã‘`);
      } else {
        endGame(false, false, `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®å‹ã¡...`);
      }
    }

    async function endGame(isWin, isDraw, resultText) {
      if(isWin) {
        let reward = betAmount * 2;
        // ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯(21ç‚¹)ã§å‹ã£ãŸå ´åˆã¯1.5å€é…å½“ãƒœãƒ¼ãƒŠã‚¹ (2.5å€è¿”ã—)
        if (playerHand.length === 2 && calculateScore(playerHand) === 21) reward = betAmount * 2.5; 
        currentPoints += reward;
        showMsg(`ğŸ‰ ${resultText} \n ${reward} ã‚‚ã£ã¡ç²å¾—ï¼`);
      } else if(isDraw) {
        currentPoints += betAmount;
        showMsg(`ğŸ¤ ${resultText} \n æ›ã‘é‡‘ãŒè¿”é‚„ã•ã‚Œã¾ã—ãŸã€‚`);
      } else {
        showMsg(`ğŸ’€ ${resultText} \n ã‚‚ã£ã¡ã‚’å¤±ã„ã¾ã—ãŸã€‚`);
      }

      document.getElementById('btn-hit').style.display = 'none';
      document.getElementById('btn-stand').style.display = 'none';
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-start').innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
      document.getElementById('bet-area').style.display = 'block';

      await fetch(GAS_URL, {
        method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      });
      updateDisplay();
    }

    function updateDisplay() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }
  </script>
</body>
</html>
