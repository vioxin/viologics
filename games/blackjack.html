<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #1a5e20; color: white; text-align: center; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; background: #2e7d32; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .card-area { min-height: 110px; margin: 10px auto; padding: 10px; border: 2px dashed #4caf50; border-radius: 10px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
    .card { background: white; width: 60px; height: 90px; border-radius: 8px; font-weight: bold; font-size: 1.5em; display: flex; align-items: center; justify-content: center; flex-direction: column; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
    .card.hidden { background: #b71c1c; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px); border: 2px solid white; color: transparent; }
    .red { color: #e74c3c; }
    .black { color: #2c3e50; }
    .controls { margin-top: 20px; }
    button { padding: 12px 25px; margin: 5px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; transition: 0.2s; }
    .btn-start { background: #f1c40f; color: #333; }
    .btn-action { background: #3498db; color: white; }
    .btn-action:hover { background: #2980b9; }
    button:disabled { background: #7f8c8d !important; color: #bdc3c7 !important; cursor: not-allowed; }
    #msg-box { font-size: 1.2em; font-weight: bold; margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 5px; min-height: 1.5em; }
    .score-badge { background: #ffca28; color: #333; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px; display: inline-block; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸƒ ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ (vs ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼)</h2>
    <p>å‚åŠ è²»: 300 ã‚‚ã£ã¡ / å‹åˆ©å ±é…¬: 600 ã‚‚ã£ã¡</p>
    <p>æ‰€æŒé‡‘: <span id="display-points" style="color: #f1c40f; font-weight: bold; font-size: 1.2em;">---</span> ã‚‚ã£ã¡</p>

    <div style="margin-top: 20px; text-align: left;">
      ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®æ‰‹æœ­ <span id="dealer-score-badge" class="score-badge" style="display:none;"></span>
    </div>
    <div id="dealer-cards" class="card-area"></div>

    <div id="msg-box">ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

    <div style="text-align: left;">
      ã‚ãªãŸã®æ‰‹æœ­ <span id="player-score-badge" class="score-badge" style="display:none;"></span>
    </div>
    <div id="player-cards" class="card-area"></div>

    <div class="controls">
      <button id="btn-start" class="btn-start" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ (300æ¶ˆè²»)</button>
      <button id="btn-hit" class="btn-action" onclick="hit()" style="display:none;">ãƒ’ãƒƒãƒˆ (ã‚‚ã†1æš)</button>
      <button id="btn-stand" class="btn-action" onclick="stand()" style="display:none;">ã‚¹ã‚¿ãƒ³ãƒ‰ (å‹è² )</button>
    </div>
    <br><a href="../index.html" style="color: #a5d6a7; text-decoration: none;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    const COST = 300;
    const REWARD = 600;

    let deck = [], playerHand = [], dealerHand = [];
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;

    function createDeck() {
      const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
      const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
      deck = [];
      for(let s of suits) {
        for(let v of values) {
          deck.push({ suit: s, value: v, isRed: (s === 'â™¥' || s === 'â™¦') });
        }
      }
      deck.sort(() => Math.random() - 0.5); // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    }

    // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆAã¯11ã‹1ã€æœ‰åˆ©ãªæ–¹ã§è¨ˆç®—ï¼‰
    function calculateScore(hand) {
      let score = 0;
      let aces = 0;
      for(let card of hand) {
        if(card.value === 'A') {
          score += 11;
          aces += 1;
        } else if(['J','Q','K'].includes(card.value)) {
          score += 10;
        } else {
          score += parseInt(card.value);
        }
      }
      while(score > 21 && aces > 0) {
        score -= 10;
        aces -= 1;
      }
      return score;
    }

    // ã‚«ãƒ¼ãƒ‰ã‚’ç”»é¢ã«æç”»ã™ã‚‹
    function renderCards(hideDealerCard) {
      const pArea = document.getElementById('player-cards');
      pArea.innerHTML = playerHand.map(c => 
        `<div class="card ${c.isRed ? 'red' : 'black'}"><div>${c.suit}</div><div>${c.value}</div></div>`
      ).join('');
      
      document.getElementById('player-score-badge').style.display = 'inline-block';
      document.getElementById('player-score-badge').innerText = calculateScore(playerHand) + "ç‚¹";

      const dArea = document.getElementById('dealer-cards');
      if (hideDealerCard) {
        // 1æšç›®ã¯è¦‹ã›ã€2æšç›®ä»¥é™ï¼ˆåˆæœŸçŠ¶æ…‹ï¼‰ã¯è£å‘ã
        dArea.innerHTML = 
          `<div class="card ${dealerHand[0].isRed ? 'red' : 'black'}"><div>${dealerHand[0].suit}</div><div>${dealerHand[0].value}</div></div>` +
          `<div class="card hidden"></div>`;
        document.getElementById('dealer-score-badge').style.display = 'none';
      } else {
        dArea.innerHTML = dealerHand.map(c => 
          `<div class="card ${c.isRed ? 'red' : 'black'}"><div>${c.suit}</div><div>${c.value}</div></div>`
        ).join('');
        document.getElementById('dealer-score-badge').style.display = 'inline-block';
        document.getElementById('dealer-score-badge').innerText = calculateScore(dealerHand) + "ç‚¹";
      }
    }

    function showMsg(msg) {
      document.getElementById('msg-box').innerText = msg;
    }

    async function startGame() {
      if(currentPoints < COST) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
      
      currentPoints -= COST;
      document.getElementById('display-points').innerText = currentPoints;

      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-hit').style.display = 'inline-block';
      document.getElementById('btn-stand').style.display = 'inline-block';
      document.getElementById('btn-hit').disabled = false;
      document.getElementById('btn-stand').disabled = false;

      createDeck();
      playerHand = [deck.pop(), deck.pop()];
      dealerHand = [deck.pop(), deck.pop()];

      renderCards(true);
      
      const pScore = calculateScore(playerHand);
      if(pScore === 21) {
        showMsg("ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ï¼ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³çµ‚äº†ã§ã™ã€‚");
        document.getElementById('btn-hit').disabled = true;
        document.getElementById('btn-stand').disabled = true;
        setTimeout(dealerTurn, 1000);
      } else {
        showMsg("ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ã€Œãƒ’ãƒƒãƒˆã€ã‹ã€Œã‚¹ã‚¿ãƒ³ãƒ‰ã€ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚");
      }
    }

    function hit() {
      playerHand.push(deck.pop());
      renderCards(true);
      const pScore = calculateScore(playerHand);
      
      if(pScore > 21) {
        document.getElementById('btn-hit').disabled = true;
        document.getElementById('btn-stand').disabled = true;
        showMsg("ğŸ’¥ ãƒãƒ¼ã‚¹ãƒˆï¼21ç‚¹ã‚’è¶…ãˆã¾ã—ãŸ...");
        setTimeout(() => endGame(false, false, "ãƒãƒ¼ã‚¹ãƒˆã«ã‚ˆã‚‹æ•—åŒ—"), 1000);
      } else if(pScore === 21) {
        document.getElementById('btn-hit').disabled = true;
        showMsg("21ç‚¹ã§ã™ï¼ã‚¹ã‚¿ãƒ³ãƒ‰ã—ã¦ãã ã•ã„ã€‚");
      }
    }

    function stand() {
      document.getElementById('btn-hit').disabled = true;
      document.getElementById('btn-stand').disabled = true;
      showMsg("ã‚¹ã‚¿ãƒ³ãƒ‰ã—ã¾ã—ãŸã€‚ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã§ã™...");
      setTimeout(dealerTurn, 1000);
    }

    // ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®AIãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ17ä»¥ä¸Šã«ãªã‚‹ã¾ã§å¼•ãï¼‰
    async function dealerTurn() {
      renderCards(false); // ä¼ã›ã‚«ãƒ¼ãƒ‰ã‚’ã‚ªãƒ¼ãƒ—ãƒ³
      showMsg("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒä¼ã›ã‚«ãƒ¼ãƒ‰ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã—ãŸã€‚");
      await new Promise(r => setTimeout(r, 1500));

      while(calculateScore(dealerHand) < 17) {
        showMsg("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®ã‚¹ã‚³ã‚¢ãŒ17æœªæº€ã®ãŸã‚ã€ã‚«ãƒ¼ãƒ‰ã‚’å¼•ãã¾ã™...");
        await new Promise(r => setTimeout(r, 1500));
        dealerHand.push(deck.pop());
        renderCards(false);
      }

      const dScore = calculateScore(dealerHand);
      if(dScore > 21) {
        showMsg("ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ãŒãƒãƒ¼ã‚¹ãƒˆã—ã¾ã—ãŸï¼");
      } else {
        showMsg(`ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã¯ ${dScore} ç‚¹ã§ã‚¹ã‚¿ãƒ³ãƒ‰ã—ã¾ã—ãŸã€‚`);
      }
      
      await new Promise(r => setTimeout(r, 1500));
      judgeResult();
    }

    function judgeResult() {
      const pScore = calculateScore(playerHand);
      const dScore = calculateScore(dealerHand);

      if(dScore > 21 || pScore > dScore) {
        endGame(true, false, `ã‚ãªãŸã®å‹ã¡ï¼ (${pScore}ç‚¹ vs ${dScore > 21 ? 'ãƒãƒ¼ã‚¹ãƒˆ' : dScore + 'ç‚¹'})`);
      } else if(pScore === dScore) {
        endGame(false, true, `å¼•ãåˆ†ã‘ (å…±ã«${pScore}ç‚¹)`);
      } else {
        endGame(false, false, `ãƒ‡ã‚£ãƒ¼ãƒ©ãƒ¼ã®å‹ã¡... (${pScore}ç‚¹ vs ${dScore}ç‚¹)`);
      }
    }

    async function endGame(isWin, isDraw, resultText) {
      if(isWin) {
        currentPoints += REWARD;
        showMsg(`ğŸ‰ ${resultText} \n ${REWARD} ã‚‚ã£ã¡ç²å¾—ï¼`);
      } else if(isDraw) {
        currentPoints += COST; // è¿”é‡‘
        showMsg(`ğŸ¤ ${resultText} \n æ›ã‘é‡‘ãŒè¿”é‚„ã•ã‚Œã¾ã—ãŸã€‚`);
      } else {
        showMsg(`ğŸ’€ ${resultText} \n ã‚‚ã£ã¡ã‚’å¤±ã„ã¾ã—ãŸã€‚`);
      }

      document.getElementById('btn-hit').style.display = 'none';
      document.getElementById('btn-stand').style.display = 'none';
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-start').innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";

      // GAS(ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
      try {
        await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
          headers: { 'Content-Type': 'text/plain' }
        });
        localStorage.setItem('userPoints', currentPoints);
        document.getElementById('display-points').innerText = currentPoints;
      } catch(e) {
        console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼", e);
      }
    }
  </script>
</body>
</html>
