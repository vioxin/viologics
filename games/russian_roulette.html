<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #2c3e50; color: white; text-align: center; padding: 20px; }
    .container { max-width: 500px; margin: 0 auto; background: #34495e; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .points { font-size: 1.5em; font-weight: bold; color: #f1c40f; }
    .btn-self { background-color: #3498db; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; font-weight: bold; font-size: 1.1em; }
    .btn-cpu { background-color: #e74c3c; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; margin: 10px; font-weight: bold; font-size: 1.1em; }
    button:disabled { background-color: #7f8c8d !important; cursor: not-allowed; }
    #log-area { margin-top: 20px; padding: 15px; background: #1a252f; border-radius: 5px; height: 150px; overflow-y: auto; text-align: left; font-size: 0.9em; line-height: 1.5; }
    #status-msg { font-size: 1.3em; font-weight: bold; margin: 15px 0; color: #ecf0f1; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ”« ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ (vs CPU)</h2>
    <p>å‚åŠ è²»: 500ã‚‚ã£ã¡ / å‹åˆ©(CPUæ­»äº¡): 1000ã‚‚ã£ã¡ç²å¾—</p>
    <p>æ‰€æŒé‡‘: <span id="display-points" class="points">---</span> ã‚‚ã£ã¡</p>

    <div id="status-msg">ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

    <button id="btn-start" onclick="startGame()" style="padding: 10px 20px; background: #2ecc71; border:none; color:white; border-radius:5px; cursor:pointer;">ã‚²ãƒ¼ãƒ é–‹å§‹ (500æ¶ˆè²»)</button>
    
    <div id="action-area" style="display: none; margin-top: 20px;">
      <button id="btn-self" class="btn-self" onclick="shoot('self')">è‡ªåˆ†ã‚’æ’ƒã¤</button>
      <button id="btn-cpu" class="btn-cpu" onclick="shoot('cpu')">CPUã‚’æ’ƒã¤</button>
    </div>

    <div id="log-area"></div>
    <br><a href="../index.html" style="color:#bdc3c7;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    const COST = 500;
    const REWARD = 1000;
    
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;
    
    let cylinder = [];
    let currentChamber = 0;
    let isPlayerTurn = true;

    function log(msg) {
      const logArea = document.getElementById('log-area');
      logArea.innerHTML += `<div>${msg}</div>`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    async function startGame() {
      if (currentPoints < COST) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
      
      currentPoints -= COST;
      document.getElementById('display-points').innerText = currentPoints;
      
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('action-area').style.display = 'block';
      document.getElementById('log-area').innerHTML = '';
      
      // ã‚·ãƒªãƒ³ãƒ€ãƒ¼ã«å¼¾ã‚’1ç™ºã‚»ãƒƒãƒˆã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
      cylinder = [0, 0, 0, 0, 0, 1];
      cylinder.sort(() => Math.random() - 0.5);
      currentChamber = 0;
      isPlayerTurn = true;

      log("ğŸ”„ ã‚«ãƒãƒ£ãƒƒ... ã‚·ãƒªãƒ³ãƒ€ãƒ¼ã‚’å›ã—ãŸã€‚");
      log("ğŸ”« å¼¾ã¯6ç™ºä¸­1ç™ºã€‚ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚");
      updateUI();
    }

    function updateUI() {
      document.getElementById('btn-self').disabled = !isPlayerTurn;
      document.getElementById('btn-cpu').disabled = !isPlayerTurn;
      document.getElementById('status-msg').innerText = isPlayerTurn ? "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³" : "CPUã®ã‚¿ãƒ¼ãƒ³...";
    }

    async function shoot(target) {
      isPlayerTurn = false; // ä¸€æ—¦ãƒœã‚¿ãƒ³ã‚’ãƒ­ãƒƒã‚¯
      updateUI();

      const isBullet = (cylinder[currentChamber] === 1);
      currentChamber++;

      log(`â–¶ ã‚ãªãŸã¯ ${target === 'self' ? 'è‡ªåˆ†' : 'CPU'} ã«å‘ã‘ã¦å¼•ãé‡‘ã‚’å¼•ã„ãŸ...`);
      await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’ã‚¿ãƒ¡ã‚‹æ¼”å‡º

      if (isBullet) {
        if (target === 'self') {
          log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ ã‚ãªãŸã¯æ­»ã‚“ã§ã—ã¾ã£ãŸ...");
          endGame(false);
        } else {
          log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ CPUã¯å€’ã‚ŒãŸï¼ã‚ãªãŸã®å‹ã¡ã§ã™ï¼");
          endGame(true);
        }
      } else {
        log("ã‚«ãƒãƒƒ... ç©ºç ²ã ã€‚");
        if (target === 'self') {
          log("ğŸ”„ è‡ªåˆ†ã‚’æ’ƒã£ã¦ç”Ÿãæ®‹ã£ãŸãŸã‚ã€ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ãŒç¶™ç¶šã—ã¾ã™ã€‚");
          isPlayerTurn = true;
          updateUI();
        } else {
          log("â¡ï¸ CPUã®ã‚¿ãƒ¼ãƒ³ã«ç§»ã‚Šã¾ã™ã€‚");
          setTimeout(cpuTurn, 1500);
        }
      }
    }

    async function cpuTurn() {
      const isBullet = (cylinder[currentChamber] === 1);
      currentChamber++;

      // CPUã®æ€è€ƒãƒ«ãƒ¼ãƒãƒ³: 80%ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ’ƒã¤ã€20%ã§è‡ªåˆ†ã‚’æ’ƒã¤
      const target = (Math.random() < 0.8) ? 'player' : 'self';
      
      log(`â–¶ CPUã¯ ${target === 'player' ? 'ã‚ãªãŸ' : 'è‡ªåˆ†è‡ªèº«'} ã«éŠƒå£ã‚’å‘ã‘ã€å¼•ãé‡‘ã‚’å¼•ã„ãŸ...`);
      await new Promise(resolve => setTimeout(resolve, 1500));

      if (isBullet) {
        if (target === 'player') {
          log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ ã‚ãªãŸã¯æ’ƒãŸã‚Œã¦ã—ã¾ã£ãŸ...");
          endGame(false);
        } else {
          log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ CPUã¯è‡ªçˆ†ã—ãŸï¼ã‚ãªãŸã®å‹ã¡ã§ã™ï¼");
          endGame(true);
        }
      } else {
        log("ã‚«ãƒãƒƒ... ç©ºç ²ã ã€‚");
        if (target === 'self') {
          log("ğŸ”„ CPUãŒç”Ÿãæ®‹ã£ãŸãŸã‚ã€CPUã®ã‚¿ãƒ¼ãƒ³ãŒç¶™ç¶šã—ã¾ã™ã€‚");
          setTimeout(cpuTurn, 1500);
        } else {
          log("â¡ï¸ ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã«ç§»ã‚Šã¾ã™ã€‚");
          isPlayerTurn = true;
          updateUI();
        }
      }
    }

    async function endGame(isPlayerWin) {
      if (isPlayerWin) {
        currentPoints += REWARD;
        log(`ğŸ’° å ±é…¬ ${REWARD} ã‚‚ã£ã¡ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`);
      } else {
        log("ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚ã‚‚ã£ã¡ã¯æ²¡åã•ã‚Œã¾ã—ãŸã€‚");
      }

      document.getElementById('action-area').style.display = 'none';
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-start').innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
      
      // GAS(ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ)ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ›´æ–°
      await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      });
      
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }
  </script>
</body>
</html>
