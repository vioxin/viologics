<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #111; color: white; text-align: center; padding: 20px; margin: 0; transition: background-color 0.1s; }
    /* ç™ºç ²æ™‚ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
    body.flash-red { background-color: #ff0000; }
    body.flash-white { background-color: #ffffff; }
    
    .container { max-width: 500px; margin: 0 auto; background: #222; padding: 30px; border-radius: 10px; border: 1px solid #444; width: 90%; box-sizing: border-box; }
    .points { font-size: 1.5em; font-weight: bold; color: #f1c40f; }
    
    .bet-area { background: #333; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    input[type="number"] { padding: 10px; font-size: 1.2em; width: 120px; text-align: right; border-radius: 5px; border: none; background: #eee; }
    
    /* ã‚·ãƒªãƒ³ãƒ€ãƒ¼å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .cylinder-icon { font-size: 4em; display: inline-block; margin: 10px 0; transition: transform 1.5s cubic-bezier(0.25, 0.1, 0.25, 1); }
    
    .btn-self { background-color: #3498db; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-weight: bold; width: 45%; }
    .btn-cpu { background-color: #e74c3c; color: white; padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; font-weight: bold; width: 45%; }
    button:disabled { background-color: #555 !important; color: #888 !important; cursor: not-allowed; }
    
    #log-area { margin-top: 20px; padding: 15px; background: #000; border-radius: 5px; height: 180px; overflow-y: auto; text-align: left; font-size: 0.95em; line-height: 1.6; border: 1px solid #444; }
    #status-msg { font-size: 1.2em; font-weight: bold; margin: 15px 0; color: #ecf0f1; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ”« ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>
    <p>æ‰€æŒé‡‘: <span id="display-points" class="points">---</span> ã‚‚ã£ã¡</p>

    <div class="bet-area" id="bet-area">
      è³­ã‘é‡‘: <input type="number" id="bet-amount" value="500" min="100" step="100"> ã‚‚ã£ã¡
    </div>

    <div>
      <span id="cylinder" class="cylinder-icon">âš™ï¸</span>
    </div>

    <div id="status-msg">è³­ã‘é‡‘ã‚’æ±ºã‚ã¦ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

    <button id="btn-start" onclick="startGame()" style="padding: 12px 25px; background: #2ecc71; border:none; color:white; border-radius:5px; font-size: 1.1em; cursor:pointer; width: 80%;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
    
    <div id="action-area" style="display: none; margin-top: 15px;">
      <button id="btn-self" class="btn-self" onclick="shoot('self')">è‡ªåˆ†ã‚’æ’ƒã¤</button>
      <button id="btn-cpu" class="btn-cpu" onclick="shoot('cpu')">CPUã‚’æ’ƒã¤</button>
    </div>

    <div id="log-area"></div>
    <br><a href="../index.html" style="color:#777;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;
    let betAmount = 0;
    let cylinder = [], currentChamber = 0, isPlayerTurn = true;

    function log(msg, color = "white") {
      const logArea = document.getElementById('log-area');
      logArea.innerHTML += `<div style="color: ${color};">${msg}</div>`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    // ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡º
    function flashScreen(isBullet) {
      document.body.classList.add(isBullet ? 'flash-red' : 'flash-white');
      setTimeout(() => {
        document.body.className = '';
      }, 100);
    }

    async function startGame() {
      betAmount = parseInt(document.getElementById('bet-amount').value);
      if (betAmount < 10 || currentPoints < betAmount) { alert("è³­ã‘é‡‘ãŒä¸æ­£ã‹ã€ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
      
      currentPoints -= betAmount;
      updateDisplay();
      
      document.getElementById('bet-area').style.display = 'none';
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('action-area').style.display = 'block';
      document.getElementById('log-area').innerHTML = '';
      
      // ã‚·ãƒªãƒ³ãƒ€ãƒ¼ã‚’å›è»¢ã•ã›ã‚‹æ¼”å‡º
      const cylIcon = document.getElementById('cylinder');
      cylIcon.style.transform = `rotate(${Math.floor(Math.random() * 1080 + 720)}deg)`;

      cylinder = [0, 0, 0, 0, 0, 1].sort(() => Math.random() - 0.5);
      currentChamber = 0;
      isPlayerTurn = true;

      log("ğŸ”„ ã‚«ãƒ©ã‚«ãƒ©ã‚«ãƒ©ãƒƒ... ã‚·ãƒªãƒ³ãƒ€ãƒ¼ã‚’å›ã—ãŸã€‚", "#aaa");
      await new Promise(r => setTimeout(r, 1500));
      log("ğŸ”« å¼¾ã¯6ç™ºä¸­1ç™ºã€‚ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚", "#f1c40f");
      updateUI();
    }

    function updateUI() {
      document.getElementById('btn-self').disabled = !isPlayerTurn;
      document.getElementById('btn-cpu').disabled = !isPlayerTurn;
      document.getElementById('status-msg').innerText = isPlayerTurn ? "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³" : "CPUã®ã‚¿ãƒ¼ãƒ³...";
    }

    async function shoot(target) {
      isPlayerTurn = false; updateUI();
      const isBullet = (cylinder[currentChamber] === 1);
      currentChamber++;

      log(`â–¶ ã‚ãªãŸã¯ ${target === 'self' ? 'è‡ªåˆ†' : 'CPU'} ã«å¼•ãé‡‘ã‚’å¼•ã„ãŸ...`);
      await new Promise(r => setTimeout(r, 1000)); 
      
      flashScreen(isBullet);

      if (isBullet) {
        if (target === 'self') { log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ ã‚ãªãŸã¯æ­»ã‚“ã§ã—ã¾ã£ãŸ...", "#e74c3c"); endGame(false); } 
        else { log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ CPUã¯å€’ã‚ŒãŸï¼ã‚ãªãŸã®å‹ã¡ï¼", "#2ecc71"); endGame(true); }
      } else {
        log("ã‚«ãƒãƒƒ... ç©ºç ²ã ã€‚", "#aaa");
        if (target === 'self') {
          log("ğŸ”„ å‹‡æ°—ã‚’è®ƒãˆã‚‰ã‚Œã€ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ç¶™ç¶šã€‚", "#3498db");
          isPlayerTurn = true; updateUI();
        } else {
          log("â¡ï¸ éŠƒã‚’æ¸¡ã—ã€CPUã®ã‚¿ãƒ¼ãƒ³ã«ç§»ã‚‹ã€‚", "#e67e22");
          setTimeout(cpuTurn, 1500);
        }
      }
    }

    async function cpuTurn() {
      const isBullet = (cylinder[currentChamber] === 1);
      currentChamber++;
      const target = (Math.random() < 0.8) ? 'player' : 'self'; // 80%ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç‹™ã†
      
      log(`â–¶ CPUã¯ ${target === 'player' ? 'ã‚ãªãŸ' : 'è‡ªåˆ†è‡ªèº«'} ã«å¼•ãé‡‘ã‚’å¼•ã„ãŸ...`);
      await new Promise(r => setTimeout(r, 1500));
      
      flashScreen(isBullet);

      if (isBullet) {
        if (target === 'player') { log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ ã‚ãªãŸã¯æ’ƒãŸã‚Œã¦ã—ã¾ã£ãŸ...", "#e74c3c"); endGame(false); } 
        else { log("ğŸ’¥ ãƒãƒ¼ãƒ³ï¼ï¼ CPUã¯è‡ªçˆ†ã—ãŸï¼ã‚ãªãŸã®å‹ã¡ï¼", "#2ecc71"); endGame(true); }
      } else {
        log("ã‚«ãƒãƒƒ... ç©ºç ²ã ã€‚", "#aaa");
        if (target === 'self') {
          log("ğŸ”„ CPUã®ã‚¿ãƒ¼ãƒ³ç¶™ç¶šã€‚", "#3498db"); setTimeout(cpuTurn, 1500);
        } else {
          log("â¡ï¸ éŠƒã‚’å—ã‘å–ã£ãŸã€‚ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã€‚", "#e67e22");
          isPlayerTurn = true; updateUI();
        }
      }
    }

    async function endGame(isPlayerWin) {
      if (isPlayerWin) {
        let reward = betAmount * 2;
        currentPoints += reward;
        log(`ğŸ’° ç”Ÿé‚„å ±é…¬ã¨ã—ã¦ ${reward} ã‚‚ã£ã¡ã‚’ç²å¾—ï¼`, "#f1c40f");
      } else {
        log("ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã€‚ã‚‚ã£ã¡ã¯æ²¡åã•ã‚ŒãŸã€‚", "#7f8c8d");
      }

      document.getElementById('action-area').style.display = 'none';
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-start').innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
      document.getElementById('bet-area').style.display = 'block';
      
      await fetch(GAS_URL, {
        method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      });
      updateDisplay();
    }

    function updateDisplay() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }
  </script>
</body>
</html>
