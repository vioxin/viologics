<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ¼ã‚«ãƒ¼ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #1a5e20; color: white; text-align: center; padding: 20px; margin: 0; }
    .container { max-width: 600px; margin: 0 auto; background: #2e7d32; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; }
    .card-area { min-height: 110px; margin: 10px auto; padding: 10px; border: 2px dashed #4caf50; border-radius: 10px; display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
    
    /* ãƒ–ãƒ©ãƒƒã‚¯ã‚¸ãƒ£ãƒƒã‚¯ã¨çµ±ä¸€ã—ãŸã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .card { background: white; width: 60px; height: 90px; border-radius: 8px; font-weight: bold; font-size: 1.5em; display: flex; align-items: center; justify-content: center; flex-direction: column; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); cursor: pointer; transition: transform 0.2s; position: relative; }
    .card.hidden { background: #b71c1c; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.1) 10px, rgba(0,0,0,0.1) 20px); border: 2px solid white; color: transparent; cursor: default; }
    .card.selected { transform: translateY(-15px); border: 3px solid #ffeb3b; }
    .red { color: #e74c3c; }
    .black { color: #2c3e50; }
    
    .bet-area { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 15px; }
    input[type="number"] { padding: 10px; font-size: 1.2em; width: 100px; text-align: right; border-radius: 5px; border: none; }
    button { padding: 12px 25px; margin: 5px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
    .btn-start { background: #f1c40f; color: #333; }
    .btn-exchange { background: #3498db; color: white; }
    #msg { font-size: 1.2em; font-weight: bold; margin: 15px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>â™ ï¸ ãƒãƒ¼ã‚«ãƒ¼ (vs CPU)</h2>
    <p>æ‰€æŒé‡‘: <span id="display-points" style="color: #f1c40f; font-weight: bold; font-size: 1.2em;">---</span> ã‚‚ã£ã¡</p>

    <div class="bet-area" id="bet-area">
      è³­ã‘é‡‘: <input type="number" id="bet-amount" value="500" min="100" step="100"> ã‚‚ã£ã¡
    </div>

    <div style="text-align: left;">CPUã®æ‰‹æœ­: <span id="cpu-hand-name"></span></div>
    <div id="cpu-cards" class="card-area"></div>

    <div id="msg">è³­ã‘é‡‘ã‚’æ±ºã‚ã¦ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

    <div style="text-align: left;">ã‚ãªãŸã®æ‰‹æœ­: <span id="player-hand-name"></span></div>
    <div id="player-cards" class="card-area"></div>

    <div class="controls">
      <button id="btn-start" class="btn-start" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      <button id="btn-exchange" class="btn-exchange" onclick="exchangeCards()" style="display:none;">é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’äº¤æ›</button>
    </div>
    <br><a href="../index.html" style="color: #a5d6a7; text-decoration: none;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;
    let betAmount = 0;
    let deck = [], playerHand = [], cpuHand = [];

    // å€ç‡èª¿æ•´ (ãƒ¯ãƒ³ãƒšã‚¢1å€=è³­ã‘é‡‘æˆ»ã‚‹, ãƒ„ãƒ¼ãƒšã‚¢2å€ãªã©)
    const payouts = [0, 1, 2, 3, 4, 5, 7, 20, 50, 100]; 
    const handRanks = ["ãƒã‚¤ã‚«ãƒ¼ãƒ‰", "ãƒ¯ãƒ³ãƒšã‚¢", "ãƒ„ãƒ¼ãƒšã‚¢", "ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰", "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", "ãƒ•ãƒ©ãƒƒã‚·ãƒ¥", "ãƒ•ãƒ«ãƒã‚¦ã‚¹", "ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰", "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥", "ãƒ­ã‚¤ãƒ¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥"];

    function createDeck() {
      const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
      const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
      deck = [];
      suits.forEach(s => {
        values.forEach((v, i) => deck.push({ suit: s, valueStr: v, value: i + 2, isRed: (s==='â™¥'||s==='â™¦') }));
      });
      deck.sort(() => Math.random() - 0.5);
    }

    async function startGame() {
      betAmount = parseInt(document.getElementById('bet-amount').value);
      if(betAmount < 100 || currentPoints < betAmount) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šãªã„ã‹ã€å…¥åŠ›ãŒä¸æ­£ã§ã™"); return; }
      
      currentPoints -= betAmount;
      updateDisplay();
      
      document.getElementById('bet-area').style.display = 'none';
      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-exchange').style.display = 'inline-block';
      document.getElementById('msg').innerText = "äº¤æ›ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œäº¤æ›ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";

      createDeck();
      playerHand = Array(5).fill().map(() => ({ card: deck.pop(), selected: false }));
      cpuHand = Array(5).fill().map(() => ({ card: deck.pop(), selected: false }));
      
      renderHands(false);
    }

    function renderHands(revealCpu) {
      const pArea = document.getElementById('player-cards');
      pArea.innerHTML = playerHand.map((item, i) => 
        `<div class="card ${item.card.isRed ? 'red' : 'black'} ${item.selected ? 'selected' : ''}" onclick="toggleSelect(${i})">
          <div>${item.card.suit}</div><div>${item.card.valueStr}</div>
        </div>`
      ).join('');
      document.getElementById('player-hand-name').innerText = evaluateHand(playerHand.map(i=>i.card)).name;

      const cArea = document.getElementById('cpu-cards');
      cArea.innerHTML = cpuHand.map(item => 
        revealCpu ? `<div class="card ${item.card.isRed ? 'red' : 'black'}"><div>${item.card.suit}</div><div>${item.card.valueStr}</div></div>`
                  : `<div class="card hidden"></div>`
      ).join('');
    }

    function toggleSelect(index) {
      playerHand[index].selected = !playerHand[index].selected;
      renderHands(false);
    }

    async function exchangeCards() {
      document.getElementById('btn-exchange').style.display = 'none';
      document.getElementById('msg').innerText = "ã‚«ãƒ¼ãƒ‰äº¤æ›ä¸­...";

      playerHand = playerHand.map(item => item.selected ? {card: deck.pop(), selected: false} : item);
      renderHands(false);
      await new Promise(r => setTimeout(r, 1000));

      // CPU AI: ãƒšã‚¢ä»¥ä¸Šãªã‚‰æ®‹ã™ã€ãƒãƒ©ãƒãƒ©ãªã‚‰å…¨äº¤æ›
      const cEval = evaluateHand(cpuHand.map(i=>i.card));
      if (cEval.rankIndex === 0) {
        cpuHand = cpuHand.map(item => ({card: deck.pop(), selected: false}));
      }
      
      document.getElementById('msg').innerText = "CPUãŒäº¤æ›ã‚’çµ‚ãˆã¾ã—ãŸã€‚ã„ã–å‹è² ï¼";
      await new Promise(r => setTimeout(r, 1500));
      judgeResult();
    }

    async function judgeResult() {
      renderHands(true);
      const pEval = evaluateHand(playerHand.map(i=>i.card));
      const cEval = evaluateHand(cpuHand.map(i=>i.card));
      
      document.getElementById('player-hand-name').innerText = pEval.name;
      document.getElementById('cpu-hand-name').innerText = cEval.name;

      let msg = "";
      if (pEval.score > cEval.score) {
        let reward = betAmount * payouts[pEval.rankIndex];
        if (reward === 0) reward = betAmount; // ãƒã‚¤ã‚«ãƒ¼ãƒ‰å‹ã¡ã§ã‚‚ãƒ™ãƒƒãƒˆé¡ã¯è¿”é‚„
        currentPoints += reward;
        msg = `ğŸ‰ ã‚ãªãŸã®å‹ã¡ï¼ ${pEval.name}ã§ ${reward}ã‚‚ã£ã¡ç²å¾—ï¼`;
      } else if (pEval.score === cEval.score) {
        currentPoints += betAmount;
        msg = "ğŸ¤ å¼•ãåˆ†ã‘ã€‚è³­ã‘é‡‘ãŒè¿”é‚„ã•ã‚Œã¾ã—ãŸã€‚";
      } else {
        msg = `ğŸ’€ è² ã‘... CPUã®${cEval.name}ã®å‹åˆ©ã€‚`;
      }

      document.getElementById('msg').innerText = msg;
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-start').innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
      document.getElementById('bet-area').style.display = 'block';

      await fetch(GAS_URL, {
        method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      });
      updateDisplay();
    }

    function updateDisplay() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }

    // æ­£ç¢ºãªå½¹åˆ¤å®š
    function evaluateHand(cards) {
      let vals = cards.map(c => c.value).sort((a,b) => b - a);
      const isFlush = cards.every(c => c.suit === cards[0].suit);
      
      // ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆåˆ¤å®š (A,5,4,3,2 ã®è€ƒæ…®)
      let isStraight = false;
      if (vals[0]===14 && vals[1]===5 && vals[2]===4 && vals[3]===3 && vals[4]===2) {
        isStraight = true; vals = [5,4,3,2,1]; // Aã‚’1ã¨ã—ã¦æ‰±ã†
      } else {
        isStraight = vals.every((v, i) => i === 0 || vals[i-1] - v === 1);
      }

      let counts = {}; vals.forEach(v => counts[v] = (counts[v] || 0) + 1);
      let freqs = Object.values(counts).sort((a,b) => b - a);
      
      let rankIndex = 0;
      if(isFlush && isStraight && vals[0] === 14) rankIndex = 9;
      else if(isFlush && isStraight) rankIndex = 8;
      else if(freqs[0] === 4) rankIndex = 7;
      else if(freqs[0] === 3 && freqs[1] === 2) rankIndex = 6;
      else if(isFlush) rankIndex = 5;
      else if(isStraight) rankIndex = 4;
      else if(freqs[0] === 3) rankIndex = 3;
      else if(freqs[0] === 2 && freqs[1] === 2) rankIndex = 2;
      else if(freqs[0] === 2) rankIndex = 1;
      
      // ã‚¹ã‚³ã‚¢è¨ˆç®— (å½¹ã®å¼·ã• + ãƒšã‚¢ç­‰ã®ã‚«ãƒ¼ãƒ‰ã®å¼·ã•)
      let score = rankIndex * 100000;
      Object.keys(counts).sort((a,b) => counts[b] - counts[a] || b - a).forEach((v, i) => {
        score += v * Math.pow(10, 3 - i);
      });

      return { name: handRanks[rankIndex], rankIndex: rankIndex, score: score };
    }
  </script>
</body>
</html>
