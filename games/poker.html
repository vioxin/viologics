<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒãƒ¼ã‚«ãƒ¼ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #0b5345; color: white; text-align: center; padding: 20px; }
    .container { max-width: 700px; margin: 0 auto; background: #148f77; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
    .card { display: inline-block; background: white; color: black; width: 60px; height: 90px; margin: 5px; border-radius: 8px; font-weight: bold; font-size: 1.5em; line-height: 90px; cursor: pointer; border: 3px solid white; user-select: none; transition: 0.2s; position: relative;}
    .card.selected { border-color: #e74c3c; transform: translateY(-10px); }
    .card.hidden { background: #2c3e50; color: #2c3e50; border-color: #fff; }
    .red { color: #e74c3c; }
    .black { color: #2c3e50; }
    .controls { margin-top: 20px; }
    button { padding: 12px 25px; font-size: 1.1em; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
    .btn-play { background: #f1c40f; color: #333; }
    .btn-exchange { background: #3498db; color: white; }
    #msg { font-size: 1.2em; font-weight: bold; margin: 15px 0; min-height: 1.5em;}
  </style>
</head>
<body>
  <div class="container">
    <h2>â™ ï¸ 5ãƒ‰ãƒ­ãƒ¼ãƒãƒ¼ã‚«ãƒ¼ (vs CPU)</h2>
    <p>å‚åŠ è²»: 500ã‚‚ã£ã¡ / æ‰€æŒé‡‘: <span id="display-points">---</span> ã‚‚ã£ã¡</p>

    <div>CPUã®æ‰‹æœ­: <span id="cpu-hand-name"></span></div>
    <div id="cpu-cards" style="min-height: 110px;"></div>

    <div id="msg">ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>

    <div>ã‚ãªãŸã®æ‰‹æœ­: <span id="player-hand-name"></span></div>
    <div id="player-cards" style="min-height: 110px;"></div>

    <div class="controls">
      <button id="btn-start" class="btn-play" onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹ (500æ¶ˆè²»)</button>
      <button id="btn-exchange" class="btn-exchange" onclick="exchangeCards()" style="display:none;">é¸æŠã—ãŸã‚«ãƒ¼ãƒ‰ã‚’äº¤æ›ã™ã‚‹</button>
    </div>
    <br><a href="../index.html" style="color: #a3e4d7;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    let currentPoints = parseInt(localStorage.getItem('userPoints')) || 10000;
    document.getElementById('display-points').innerText = currentPoints;

    let deck = [], playerHand = [], cpuHand = [];
    const suits = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
    const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    
    // å½¹ã®å¼·ã•ã¨é…å½“å€ç‡
    const handRanks = ["ãƒã‚¤ã‚«ãƒ¼ãƒ‰", "ãƒ¯ãƒ³ãƒšã‚¢", "ãƒ„ãƒ¼ãƒšã‚¢", "ã‚¹ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰", "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", "ãƒ•ãƒ©ãƒƒã‚·ãƒ¥", "ãƒ•ãƒ«ãƒã‚¦ã‚¹", "ãƒ•ã‚©ãƒ¼ã‚«ãƒ¼ãƒ‰", "ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥", "ãƒ­ã‚¤ãƒ¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥"];
    const payouts = [0, 2, 3, 5, 10, 15, 20, 50, 100, 500]; // ãƒ¯ãƒ³ãƒšã‚¢ã§2å€(1000æˆ»ã‚‹)ãªã©

    function createDeck() {
      deck = [];
      for(let s of suits) {
        for(let i=0; i<values.length; i++) {
          deck.push({ suit: s, valueStr: values[i], value: i + 2, isRed: (s==='â™¥'||s==='â™¦') });
        }
      }
      deck.sort(() => Math.random() - 0.5);
    }

    async function startGame() {
      if(currentPoints < 500) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“"); return; }
      currentPoints -= 500;
      updatePoints();

      createDeck();
      playerHand = []; cpuHand = [];
      for(let i=0; i<5; i++) {
        playerHand.push({ card: deck.pop(), selected: false });
        cpuHand.push({ card: deck.pop(), selected: false });
      }

      document.getElementById('btn-start').style.display = 'none';
      document.getElementById('btn-exchange').style.display = 'inline-block';
      document.getElementById('msg').innerText = "äº¤æ›ã—ãŸã„ã‚«ãƒ¼ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã‚“ã§ãã ã•ã„ã€‚";
      document.getElementById('cpu-hand-name').innerText = "";
      
      renderHands(false); // CPUã®æ‰‹æœ­ã¯è£å‘ã
    }

    function renderHands(revealCpu) {
      const pArea = document.getElementById('player-cards');
      pArea.innerHTML = '';
      playerHand.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = `card ${item.card.isRed ? 'red' : 'black'} ${item.selected ? 'selected' : ''}`;
        div.innerHTML = `${item.card.suit}<br>${item.card.valueStr}`;
        div.onclick = () => { item.selected = !item.selected; renderHands(revealCpu); };
        pArea.appendChild(div);
      });
      document.getElementById('player-hand-name').innerText = evaluateHand(playerHand.map(i=>i.card)).name;

      const cArea = document.getElementById('cpu-cards');
      cArea.innerHTML = '';
      cpuHand.forEach(item => {
        const div = document.createElement('div');
        if(revealCpu) {
          div.className = `card ${item.card.isRed ? 'red' : 'black'}`;
          div.innerHTML = `${item.card.suit}<br>${item.card.valueStr}`;
        } else {
          div.className = `card hidden`;
          div.innerHTML = `ğŸ‚ `;
        }
        cArea.appendChild(div);
      });
    }

    async function exchangeCards() {
      document.getElementById('btn-exchange').style.display = 'none';
      document.getElementById('msg').innerText = "ã‚«ãƒ¼ãƒ‰äº¤æ›ä¸­...";

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®äº¤æ›
      playerHand = playerHand.map(item => item.selected ? {card: deck.pop(), selected: false} : item);
      renderHands(false);

      await new Promise(r => setTimeout(r, 1000));

      // CPUã®AIæ€è€ƒï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼šãƒšã‚¢ãªã©ã®é‡è¤‡æ•°å­—ã‚’æ®‹ã—ã€ãƒãƒ©ãƒãƒ©ãªã‚‰ä¸€ç•ªå¤§ãã„æ•°å­—ã ã‘æ®‹ã—ã¦å…¨å–ã£æ›¿ãˆï¼‰
      let valCounts = {};
      cpuHand.forEach(item => valCounts[item.card.value] = (valCounts[item.card.value] || 0) + 1);
      let keepValues = Object.keys(valCounts).filter(k => valCounts[k] >= 2).map(Number);
      
      if(keepValues.length === 0) {
        // ãƒšã‚¢ãŒç„¡ã„å ´åˆã€ä¸€ç•ªå¼·ã„ã‚«ãƒ¼ãƒ‰1æšã ã‘æ®‹ã™
        let maxVal = Math.max(...cpuHand.map(i => i.card.value));
        keepValues = [maxVal];
      }

      cpuHand = cpuHand.map(item => keepValues.includes(item.card.value) ? item : {card: deck.pop(), selected: false});
      
      document.getElementById('msg').innerText = "CPUãŒã‚«ãƒ¼ãƒ‰ã‚’äº¤æ›ã—ã¾ã—ãŸã€‚ã„ã–å‹è² ï¼";
      await new Promise(r => setTimeout(r, 1500));

      judgeResult();
    }

    async function judgeResult() {
      renderHands(true); // CPUã®æ‰‹æœ­ã‚’ã‚ªãƒ¼ãƒ—ãƒ³
      
      const pEval = evaluateHand(playerHand.map(i=>i.card));
      const cEval = evaluateHand(cpuHand.map(i=>i.card));
      
      document.getElementById('player-hand-name').innerText = pEval.name;
      document.getElementById('cpu-hand-name').innerText = cEval.name;

      let msg = "";
      let win = false;
      let draw = false;

      // ã‚¹ã‚³ã‚¢ã§å‹æ•—åˆ¤å®š
      if (pEval.score > cEval.score) win = true;
      else if (pEval.score === cEval.score) draw = true;

      if (win) {
        let reward = 500 * payouts[pEval.rankIndex]; // å½¹ã«å¿œã˜ãŸå€ç‡
        if (reward === 0) reward = 500; // ãƒã‚¤ã‚«ãƒ¼ãƒ‰å‹ã¡ã§ã‚‚æœ€ä½é™æ›ã‘é‡‘ã¯æˆ»ã‚‹ä»•æ§˜ã«
        currentPoints += reward;
        msg = `ğŸ‰ ã‚ãªãŸã®å‹ã¡ï¼ ${pEval.name}ã§ ${reward}ã‚‚ã£ã¡ç²å¾—ï¼`;
      } else if (draw) {
        currentPoints += 500; // å¼•ãåˆ†ã‘ã¯è¿”é‡‘
        msg = "ğŸ¤ å¼•ãåˆ†ã‘ã€‚ã‚‚ã£ã¡ãŒè¿”é‚„ã•ã‚Œã¾ã—ãŸã€‚";
      } else {
        msg = `ğŸ’€ è² ã‘... CPUã®${cEval.name}ã®å‹åˆ©ã§ã™ã€‚`;
      }

      document.getElementById('msg').innerText = msg;
      document.getElementById('btn-start').style.display = 'inline-block';
      document.getElementById('btn-start').innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";

      // GASé€šä¿¡
      await fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      });
      updatePoints();
    }

    function updatePoints() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }

    // --- å½¹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (ã‹ãªã‚Šé•·ããªã‚‹ã®ã§ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…) ---
    function evaluateHand(cards) {
      cards.sort((a,b) => b.value - a.value); // é™é †ã‚½ãƒ¼ãƒˆ
      const isFlush = cards.every(c => c.suit === cards[0].suit);
      const isStraight = cards.every((c, i) => i === 0 || cards[i-1].value - c.value === 1);
      
      let counts = {};
      cards.forEach(c => counts[c.value] = (counts[c.value] || 0) + 1);
      let pairs = Object.values(counts).filter(v => v === 2).length;
      let three = Object.values(counts).filter(v => v === 3).length;
      let four = Object.values(counts).filter(v => v === 4).length;

      let rankIndex = 0;
      if(isFlush && isStraight && cards[0].value === 14) rankIndex = 9; // ãƒ­ã‚¤ãƒ¤ãƒ«
      else if(isFlush && isStraight) rankIndex = 8;
      else if(four === 1) rankIndex = 7;
      else if(three === 1 && pairs === 1) rankIndex = 6; // ãƒ•ãƒ«ãƒã‚¦ã‚¹
      else if(isFlush) rankIndex = 5;
      else if(isStraight) rankIndex = 4;
      else if(three === 1) rankIndex = 3;
      else if(pairs === 2) rankIndex = 2;
      else if(pairs === 1) rankIndex = 1;
      
      // åŒå½¹ã ã£ãŸå ´åˆã®åˆ¤å®šç”¨ã‚¹ã‚³ã‚¢ï¼ˆå¼·ã•ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æœ€ä¸Šä½ã«ã€ãã®ä¸‹ã«ã‚«ãƒ¼ãƒ‰ã®å€¤ã‚’è¶³ã™ï¼‰
      let score = rankIndex * 1000000;
      // å½¹ã‚’æ§‹æˆã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é‡ã¿ä»˜ã‘ã—ã¦ã‚¹ã‚³ã‚¢åŒ–ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      cards.forEach((c, i) => score += c.value * Math.pow(10, 4 - i));

      return { name: handRanks[rankIndex], rankIndex: rankIndex, score: score };
    }
  </script>
</body>
</html>
