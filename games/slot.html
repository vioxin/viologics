<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¹ãƒ­ãƒƒãƒˆ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <style>
    body { font-family: sans-serif; background-color: #2c3e50; color: white; text-align: center; padding: 20px; margin: 0; }
    .container { max-width: 500px; margin: 0 auto; background: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 90%; }
    .reels { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
    .reel { width: 80px; height: 100px; background: white; color: black; font-size: 3em; display: flex; align-items: center; justify-content: center; border-radius: 10px; border: 5px solid #bdc3c7; }
    .kakuhen { border-color: #f1c40f; box-shadow: 0 0 20px #f1c40f; animation: pulse 1s infinite alternate; }
    @keyframes pulse { from { box-shadow: 0 0 10px #f1c40f; } to { box-shadow: 0 0 30px #e67e22; } }
    button { padding: 15px 30px; font-size: 1.2em; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; width: 80%; max-width: 300px; }
    button:disabled { background: #7f8c8d; cursor: not-allowed; }
    #msg { font-size: 1.2em; font-weight: bold; margin: 15px 0; color: #f1c40f; min-height: 1.5em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ° ã‚¹ãƒ­ãƒƒãƒˆ</h2>
    <p>1ãƒ—ãƒ¬ã‚¤: 100 ã‚‚ã£ã¡ (å›ºå®š)</p>
    <p>æ‰€æŒé‡‘: <span id="display-points">---</span> ã‚‚ã£ã¡</p>
    <p id="mode-text" style="color: #bdc3c7;">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</p>

    <div class="reels">
      <div id="reel1" class="reel">ğŸ’</div>
      <div id="reel2" class="reel">ğŸ’</div>
      <div id="reel3" class="reel">ğŸ’</div>
    </div>

    <div id="msg">ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    <button id="btn-spin" onclick="spin()">ã‚¹ãƒ”ãƒ³ï¼ (100æ¶ˆè²»)</button>
    <br><br><a href="../index.html" style="color:#bdc3c7;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;

    const symbols = ['ğŸ’', 'ğŸ””', 'ğŸ‰', 'â­', '7ï¸âƒ£'];
    let isKakuhen = false; // ç¢ºå¤‰ãƒ•ãƒ©ã‚°
    let spinIntervals = [];

    async function spin() {
      if (currentPoints < 100) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
      currentPoints -= 100;
      updateDisplay();

      document.getElementById('btn-spin').disabled = true;
      document.getElementById('msg').innerText = "å›è»¢ä¸­...";

      const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
      
      // é«˜é€Ÿåˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      reels.forEach((reel, i) => {
        spinIntervals[i] = setInterval(() => {
          reel.innerText = symbols[Math.floor(Math.random() * symbols.length)];
        }, 50);
      });

      // åœæ­¢å‡¦ç†
      const results = [];
      for (let i = 0; i < 3; i++) {
        await new Promise(r => setTimeout(r, 800 + i * 500)); // å·¦ã‹ã‚‰é †ã«æ­¢ã¾ã‚‹
        clearInterval(spinIntervals[i]);
        
        // ç¢ºå¤‰ä¸­ã¯å½“ãŸã‚Šã‚„ã™ãã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆ7ï¸âƒ£ã‚„â­ãŒå‡ºã‚„ã™ã„ï¼‰
        let symbol;
        if (isKakuhen && Math.random() > 0.3) {
          symbol = (Math.random() > 0.5) ? '7ï¸âƒ£' : 'â­';
        } else {
          symbol = symbols[Math.floor(Math.random() * symbols.length)];
        }
        
        // å¼·åˆ¶çš„ã«æƒãˆã‚‹æ¼”å‡ºï¼ˆãƒ‡ãƒ¢ç”¨ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        if (i === 2 && isKakuhen && Math.random() > 0.5) symbol = results[0]; 

        reels[i].innerText = symbol;
        results.push(symbol);
      }

      judge(results);
    }

    async function judge(res) {
      const msgEl = document.getElementById('msg');
      let reward = 0;

      if (res[0] === res[1] && res[1] === res[2]) {
        if (res[0] === '7ï¸âƒ£') { reward = 2000; msgEl.innerText = "ğŸ‰å¤§å½“ãŸã‚Šï¼2000ã‚‚ã£ã¡ç²å¾—ï¼ç¢ºå¤‰çªå…¥ï¼"; isKakuhen = true; }
        else if (res[0] === 'â­') { reward = 500; msgEl.innerText = "â­ä¸­å½“ãŸã‚Šï¼500ã‚‚ã£ã¡ç²å¾—ï¼"; }
        else { reward = 300; msgEl.innerText = "âœ¨å°å½“ãŸã‚Šï¼300ã‚‚ã£ã¡ç²å¾—ï¼"; }
      } else {
        msgEl.innerText = "ãƒã‚ºãƒ¬...";
        if (isKakuhen && Math.random() > 0.7) {
          isKakuhen = false; // ç¢ºç‡ã§ç¢ºå¤‰çµ‚äº†
          msgEl.innerText += " (ç¢ºå¤‰çµ‚äº†)";
        }
      }

      currentPoints += reward;
      updateDisplay();
      
      // ç¢ºå¤‰æ¼”å‡ºã®åˆ‡ã‚Šæ›¿ãˆ
      document.getElementById('mode-text').innerText = isKakuhen ? "ğŸ”¥ç¢ºå¤‰ãƒ¢ãƒ¼ãƒ‰ğŸ”¥ (å¤§ãƒãƒ£ãƒ³ã‚¹ï¼)" : "é€šå¸¸ãƒ¢ãƒ¼ãƒ‰";
      document.getElementById('mode-text').style.color = isKakuhen ? "#f1c40f" : "#bdc3c7";
      document.querySelectorAll('.reel').forEach(r => isKakuhen ? r.classList.add('kakuhen') : r.classList.remove('kakuhen'));

      document.getElementById('btn-spin').disabled = false;
      
      // GASåŒæœŸ
      await fetch(GAS_URL, {
        method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      });
    }

    function updateDisplay() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }
  </script>
</body>
</html>
