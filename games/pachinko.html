<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‘ãƒãƒ³ã‚³ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #2c3e50; color: white; text-align: center; padding: 20px; margin: 0; }
    .container { max-width: 500px; margin: 0 auto; background: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 90%; }
    h2 { color: #f1c40f; margin-top: 0; }
    .status-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
    .points { font-size: 1.2em; font-weight: bold; color: #f1c40f; }
    
    #pachinko-area { position: relative; margin: 0 auto; width: 100%; max-width: 400px; border: 5px solid #bdc3c7; border-radius: 10px; background: #1a252f; overflow: hidden; }
    /* Matter.jsã®Canvasã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã•ã›ã‚‹ */
    canvas { width: 100% !important; height: auto !important; display: block; }
    
    #slot-screen { background: #000; color: #00ff00; font-family: 'Courier New', monospace; font-size: 1.5em; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-weight: bold; border: 2px solid #2ecc71; letter-spacing: 2px; }
    .jackpot { color: #ff00ff !important; animation: flash 0.5s infinite alternate; }
    @keyframes flash { from { text-shadow: 0 0 10px #ff00ff; } to { text-shadow: 0 0 30px #ff00ff, 0 0 50px #ff00ff; } }

    button { padding: 15px 30px; font-size: 1.2em; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 80%; max-width: 250px; transition: 0.1s; margin-bottom: 15px; }
    button:active { transform: scale(0.95); }
    button:disabled { background: #7f8c8d; cursor: not-allowed; transform: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ° ç‰©ç†ãƒ‘ãƒãƒ³ã‚³</h2>
    
    <div class="status-bar">
      <div>æ‰€æŒé‡‘: <span id="display-points" class="points">---</span></div>
      <div>1çƒ: 100 ã‚‚ã£ã¡</div>
    </div>

    <div id="slot-screen">å¾…æ©Ÿä¸­...</div>

    <div id="pachinko-area"></div>

    <br>
    <button id="btn-shoot" onclick="shoot()">1çƒæ‰“ã¤ (100æ¶ˆè²»)</button>
    
    <br><a href="../index.html" style="color:#bdc3c7; text-decoration: none;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec";
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;

    // --- Matter.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
    const { Engine, Render, Runner, World, Bodies, Events, Composite } = Matter;
    const engine = Engine.create();
    
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å†…éƒ¨ã‚µã‚¤ã‚ºï¼ˆè¦‹ãŸç›®ã¯CSSã§ç¸®å°ãƒ»æ‹¡å¤§ã•ã‚Œã¾ã™ï¼‰
    const width = 400;
    const height = 600;

    const render = Render.create({
      element: document.getElementById('pachinko-area'),
      engine: engine,
      options: {
        width: width, height: height,
        wireframes: false, background: '#1a252f'
      }
    });

    // --- ç›¤é¢ã®ä½œæˆï¼ˆé‡˜ã¨å£ã¨ç©´ï¼‰ ---
    const bodies = [];
    
    // å¤–å£
    bodies.push(Bodies.rectangle(width/2, -50, width, 100, { isStatic: true })); // å¤©äº•
    bodies.push(Bodies.rectangle(-25, height/2, 50, height, { isStatic: true })); // å·¦å£
    bodies.push(Bodies.rectangle(width+25, height/2, 50, height, { isStatic: true })); // å³å£

    // é‡˜ï¼ˆãƒ”ãƒ³ï¼‰ã‚’ç­‰é–“éš”ã«é…ç½®
    const rows = 10;
    const cols = 9;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        // è¡Œã”ã¨ã«å°‘ã—ãšã‚‰ã™ï¼ˆåƒé³¥é…ç½®ï¼‰
        let xOffset = (r % 2 === 0) ? 0 : 20;
        let x = c * 45 + 20 + xOffset;
        let y = r * 45 + 100;
        
        // ç”»é¢å¤–ã«ã¯ã¿å‡ºã‚‹é‡˜ã¯ä½œã‚‰ãªã„
        if (x > 10 && x < width - 10) {
          bodies.push(Bodies.circle(x, y, 4, { 
            isStatic: true, 
            restitution: 0.5, // å¼¾åŠ›
            render: { fillStyle: '#bdc3c7' } 
          }));
        }
      }
    }

    // ä¸‹éƒ¨ã®ä»•åˆ‡ã‚Šã¨å…¥è³ç©´ï¼ˆã‚»ãƒ³ã‚µãƒ¼ï¼‰
    bodies.push(Bodies.rectangle(width/2 - 60, height - 20, 10, 80, { isStatic: true, render: { fillStyle: '#7f8c8d' } }));
    bodies.push(Bodies.rectangle(width/2 + 60, height - 20, 10, 80, { isStatic: true, render: { fillStyle: '#7f8c8d' } }));
    
    // ä¸­å¤®STARTç©´ã‚»ãƒ³ã‚µãƒ¼ï¼ˆå½“ãŸã‚Šåˆ¤å®šç”¨ï¼‰
    const startSensor = Bodies.rectangle(width/2, height - 10, 100, 20, { 
      isStatic: true, isSensor: true, label: 'START_HOLE',
      render: { fillStyle: '#e74c3c' } 
    });
    bodies.push(startSensor);

    World.add(engine.world, bodies);
    Render.run(render);
    Runner.run(Runner.create(), engine);

    // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
    let isShooting = false;

    function shoot() {
      if (currentPoints < 100) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
      if (isShooting) return; // é€£æ‰“é˜²æ­¢
      
      isShooting = true;
      document.getElementById('btn-shoot').disabled = true;

      // è³­ã‘é‡‘æ¶ˆè²»
      currentPoints -= 100;
      updateDisplay();

      // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‹ã‚‰çƒã‚’è½ã¨ã™ï¼ˆç‰©ç†æ¼”ç®—ã«ç¢ºç‡ã®æºã‚‰ãã‚’ä¸ãˆã‚‹ï¼‰
      const randomX = (width / 2) + (Math.random() * 60 - 30);
      const ball = Bodies.circle(randomX, 20, 8, {
        restitution: 0.7, // çƒã®å¼¾ã¿ã‚„ã™ã•
        friction: 0.005,
        density: 0.05,
        label: 'BALL',
        render: { fillStyle: '#f1c40f' }
      });

      World.add(engine.world, ball);

      // é€£æ‰“é˜²æ­¢è§£é™¤ (0.5ç§’å¾Œ)
      setTimeout(() => {
        isShooting = false;
        document.getElementById('btn-shoot').disabled = false;
      }, 500);

      // 10ç§’çµŒã£ã¦ã‚‚è½ã¡ãã‚‰ãªã‹ã£ãŸçƒã¯å‰Šé™¤ï¼ˆè©°ã¾ã‚Šé˜²æ­¢ï¼‰
      setTimeout(() => {
        if (ball.parent) World.remove(engine.world, ball);
      }, 10000);
    }

    // è¡çªåˆ¤å®šï¼ˆçƒãŒç©´ã«å…¥ã£ãŸã‹ã€ä¸‹ã«è½ã¡ãŸã‹ï¼‰
    Events.on(engine, 'collisionStart', function(event) {
      const pairs = event.pairs;
      for (let i = 0; i < pairs.length; i++) {
        const bodyA = pairs[i].bodyA;
        const bodyB = pairs[i].bodyB;

        // STARTç©´ã«å…¥ã£ãŸå ´åˆ
        if ((bodyA.label === 'BALL' && bodyB.label === 'START_HOLE') || 
            (bodyB.label === 'BALL' && bodyA.label === 'START_HOLE')) {
          
          const ball = bodyA.label === 'BALL' ? bodyA : bodyB;
          World.remove(engine.world, ball); // çƒã‚’æ¶ˆã™
          triggerSlot(); // æŠ½é¸é–‹å§‹ï¼
        }
      }
    });

    // ç”»é¢å¤–ï¼ˆãƒã‚ºãƒ¬ï¼‰ã«è½ã¡ãŸçƒã‚’æ¶ˆã™ç›£è¦–ãƒ«ãƒ¼ãƒ—
    Events.on(engine, 'afterUpdate', function() {
      const allBodies = Composite.allBodies(engine.world);
      allBodies.forEach(body => {
        if (body.label === 'BALL' && body.position.y > height + 20) {
          World.remove(engine.world, body); // ãƒã‚ºãƒ¬çƒã‚’å‰Šé™¤
        }
      });
    });

    // --- ãƒ‡ã‚¸ã‚¿ãƒ«æŠ½é¸ï¼ˆç¢ºç‡è¦ç´ ï¼‰ ---
    async function triggerSlot() {
      const screen = document.getElementById('slot-screen');
      screen.classList.remove('jackpot');
      screen.style.color = "#00ff00";
      
      // æ¼”å‡ºï¼šæ•°å­—ãŒãƒ‘ãƒ©ãƒ‘ãƒ©å¤‰ã‚ã‚‹
      let spinCount = 0;
      const spinInterval = setInterval(() => {
        screen.innerText = `${Math.floor(Math.random()*9)+1} ${Math.floor(Math.random()*9)+1} ${Math.floor(Math.random()*9)+1}`;
        spinCount++;
      }, 50);

      await new Promise(r => setTimeout(r, 1500));
      clearInterval(spinInterval);

      // ç¢ºç‡åˆ¤å®š
      const rand = Math.random();
      let reward = 0;

      if (rand < 0.10) {
        // 10%ã§å¤§å½“ãŸã‚Š
        screen.innerText = "7 7 7 (å¤§å½“ã‚Š!)";
        screen.classList.add('jackpot');
        reward = 1500;
      } else if (rand < 0.40) {
        // 30%ã§å°å½“ãŸã‚Š
        screen.innerText = "3 3 3 (å°å½“ã‚Š)";
        screen.style.color = "#f1c40f";
        reward = 300;
      } else {
        // 60%ã§ãƒã‚ºãƒ¬
        screen.innerText = "1 4 7 (ãƒã‚ºãƒ¬)";
        screen.style.color = "#7f8c8d";
      }

      if (reward > 0) {
        currentPoints += reward;
        updateDisplay();
        syncGas();
      }
    }

    function updateDisplay() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }

    // GASé€šä¿¡ï¼ˆã‚¹ãƒ‘ãƒ é˜²æ­¢ã®ãŸã‚å¤§å½“ãŸã‚Šæ™‚ãªã©ã«å‘¼ã³å‡ºã—ï¼‰
    function syncGas() {
      fetch(GAS_URL, {
        method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      }).catch(e => console.error("GASåŒæœŸã‚¨ãƒ©ãƒ¼"));
    }
  </script>
</body>
</html>
