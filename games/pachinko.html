<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ‘ãƒãƒ³ã‚³ - ã‚‚ã£ã¡ã‚«ã‚¸ãƒ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body { font-family: sans-serif; background-color: #2c3e50; color: white; text-align: center; padding: 20px; margin: 0; overflow-x: hidden; }
    .container { max-width: 500px; margin: 0 auto; background: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 90%; position: relative; }
    h2 { color: #f1c40f; margin-top: 0; }
    .status-bar { display: flex; justify-content: space-around; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 10px; }
    .points { font-size: 1.2em; font-weight: bold; color: #f1c40f; }
    
    #pachinko-area { position: relative; margin: 0 auto; width: 100%; max-width: 400px; border: 5px solid #bdc3c7; border-radius: 10px; background: #1a252f; overflow: hidden; }
    canvas { width: 100% !important; height: auto !important; display: block; }
    
    /* å¤§å½“ãŸã‚Šæ™‚ã®ãƒ‰æ´¾æ‰‹ãªãƒ†ã‚­ã‚¹ãƒˆæ¼”å‡º */
    #jackpot-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: none; opacity: 0; transition: opacity 0.3s; border-radius: 10px; }
    #jackpot-overlay.show { opacity: 1; }
    .jackpot-text { font-size: 3em; color: #ffeb3b; font-weight: bold; text-shadow: 0 0 20px #ff0000, 0 0 40px #ff0000, 0 0 60px #ff5722; transform: scale(0.1); transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); margin: 0; }
    .jackpot-sub { font-size: 1.5em; color: #fff; margin-top: 10px; text-shadow: 0 0 10px #2196f3; transform: scale(0.1); transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); transition-delay: 0.1s; }
    #jackpot-overlay.show .jackpot-text, #jackpot-overlay.show .jackpot-sub { transform: scale(1); }

    button { padding: 15px 30px; font-size: 1.2em; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 80%; max-width: 250px; transition: 0.1s; margin-top: 15px; margin-bottom: 15px; }
    button:active { transform: scale(0.95); }
    button:disabled { background: #7f8c8d; cursor: not-allowed; transform: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ° ç‰©ç†ãƒ‘ãƒãƒ³ã‚³</h2>
    
    <div class="status-bar">
      <div>æ‰€æŒé‡‘: <span id="display-points" class="points">---</span></div>
      <div>1çƒ: 100 ã‚‚ã£ã¡</div>
    </div>

    <div id="pachinko-area">
      <div id="jackpot-overlay">
        <p class="jackpot-text">å¤§å½“ãŸã‚Š!!</p>
        <p class="jackpot-sub">+1,000 ã‚‚ã£ã¡ç²å¾—</p>
      </div>
    </div>

    <button id="btn-shoot" onclick="shoot()">1çƒæ‰“ã¤ (100æ¶ˆè²»)</button>
    
    <br><a href="../index.html" style="color:#bdc3c7; text-decoration: none;">ğŸ”™ ãƒã‚¤ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyOmbY7H3r9MIDMsH4m7BifWwIknowmiE9nD44wXZVFrffQYOPr_OSvaejnyQvAdVtZNw/exec"; // â˜…æ›¸ãæ›ãˆã¦ãã ã•ã„
    let currentPoints = parseInt(localStorage.getItem('userPoints'));
    document.getElementById('display-points').innerText = currentPoints;

    // --- Matter.js ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ---
    const { Engine, Render, Runner, World, Bodies, Events, Composite } = Matter;
    const engine = Engine.create();
    
    const width = 400;
    const height = 600;

    const render = Render.create({
      element: document.getElementById('pachinko-area'),
      engine: engine,
      options: {
        width: width, height: height,
        wireframes: false, background: '#1a252f'
      }
    });

    // --- ç›¤é¢ã®ä½œæˆ ---
    const bodies = [];
    
    bodies.push(Bodies.rectangle(width/2, -50, width, 100, { isStatic: true })); 
    bodies.push(Bodies.rectangle(-25, height/2, 50, height, { isStatic: true })); 
    bodies.push(Bodies.rectangle(width+25, height/2, 50, height, { isStatic: true }));

    // é‡˜ï¼ˆãƒ”ãƒ³ï¼‰
    const rows = 10;
    const cols = 9;
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        let xOffset = (r % 2 === 0) ? 0 : 20;
        let x = c * 45 + 20 + xOffset;
        let y = r * 45 + 100;
        
        if (x > 10 && x < width - 10) {
          bodies.push(Bodies.circle(x, y, 4, { 
            isStatic: true, 
            restitution: 0.5,
            render: { fillStyle: '#bdc3c7' } 
          }));
        }
      }
    }

    // å…¥è³ç©´ã®ä»•åˆ‡ã‚Š
    bodies.push(Bodies.rectangle(width/2 - 50, height - 20, 10, 80, { isStatic: true, render: { fillStyle: '#7f8c8d' } }));
    bodies.push(Bodies.rectangle(width/2 + 50, height - 20, 10, 80, { isStatic: true, render: { fillStyle: '#7f8c8d' } }));
    
    // å½“ãŸã‚Šç©´ã‚»ãƒ³ã‚µãƒ¼
    const startSensor = Bodies.rectangle(width/2, height - 10, 80, 20, { 
      isStatic: true, isSensor: true, label: 'WIN_HOLE',
      render: { fillStyle: '#e74c3c' } 
    });
    bodies.push(startSensor);

    World.add(engine.world, bodies);
    Render.run(render);
    Runner.run(Runner.create(), engine);

    // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
    let isShooting = false;

    function shoot() {
      if (currentPoints < 100) { alert("ã‚‚ã£ã¡ãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }
      if (isShooting) return;
      
      isShooting = true;
      document.getElementById('btn-shoot').disabled = true;

      currentPoints -= 100;
      updateDisplay();

      const randomX = (width / 2) + (Math.random() * 80 - 40);
      const ball = Bodies.circle(randomX, 20, 8, {
        restitution: 0.7, friction: 0.005, density: 0.05, label: 'BALL',
        render: { fillStyle: '#f1c40f' }
      });

      World.add(engine.world, ball);

      setTimeout(() => {
        isShooting = false;
        document.getElementById('btn-shoot').disabled = false;
      }, 500);

      setTimeout(() => {
        if (ball.parent) World.remove(engine.world, ball);
      }, 10000);
    }

    // è¡çªåˆ¤å®šï¼ˆç©´ã«å…¥ã£ãŸã‹ï¼‰
    Events.on(engine, 'collisionStart', function(event) {
      const pairs = event.pairs;
      for (let i = 0; i < pairs.length; i++) {
        const bodyA = pairs[i].bodyA;
        const bodyB = pairs[i].bodyB;

        if ((bodyA.label === 'BALL' && bodyB.label === 'WIN_HOLE') || 
            (bodyB.label === 'BALL' && bodyA.label === 'WIN_HOLE')) {
          const ball = bodyA.label === 'BALL' ? bodyA : bodyB;
          World.remove(engine.world, ball);
          triggerJackpot(); // å¤§å½“ãŸã‚Šæ¼”å‡ºã¸ï¼
        }
      }
    });

    Events.on(engine, 'afterUpdate', function() {
      const allBodies = Composite.allBodies(engine.world);
      allBodies.forEach(body => {
        if (body.label === 'BALL' && body.position.y > height + 20) {
          World.remove(engine.world, body);
        }
      });
    });

    // --- ãƒ‰æ´¾æ‰‹ãªå¤§å½“ãŸã‚Šæ¼”å‡º ---
    function triggerJackpot() {
      currentPoints += 1000;
      updateDisplay();
      syncGas();

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
      const overlay = document.getElementById('jackpot-overlay');
      overlay.classList.add('show');

      // ç´™å¹é›ªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (3ç§’é–“é€£ç¶šã§ç™ºå°„)
      let duration = 3000;
      let end = Date.now() + duration;

      (function frame() {
        confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#ff0000', '#ffff00', '#00ff00', '#0000ff'] });
        confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#ff0000', '#ffff00', '#00ff00', '#0000ff'] });
        
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      }());

      // 4ç§’å¾Œã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¶ˆã™
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 4000);
    }

    function updateDisplay() {
      localStorage.setItem('userPoints', currentPoints);
      document.getElementById('display-points').innerText = currentPoints;
    }

    function syncGas() {
      fetch(GAS_URL, {
        method: 'POST', body: JSON.stringify({ action: 'updatePoints', id: localStorage.getItem('userId'), newPoints: currentPoints }),
        headers: { 'Content-Type': 'text/plain' }
      }).catch(e => console.error("GASåŒæœŸã‚¨ãƒ©ãƒ¼"));
    }
  </script>
</body>
</html>
